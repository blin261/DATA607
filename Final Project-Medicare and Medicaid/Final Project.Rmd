---
title: "Final Project"
author: "Bin Lin"
date: "2016-12-16"
output: html_document
---

Introduction:

Since 2014, US has been spending more than $3 trillion dollars annually on healthcare and the average health expenditure is about $9523 per capita. In addition, these numbers keep increasing as those baby boomers start hitting their retirement age. If america spends too much resources on healthcare, there will be less money and resources we can spend on elsewhere because the budget is always limited. 

Medicare and Medicaid are two of the largest federal entitlement programs. People who enroll under Medicare are usually elderly who are over 65 years old. On the other hand, the medicaid is designed for people whose household incomes are under certain limit of federal poverty level. 


For this final project, I want to create a markdown file that can show the breakdown of spending of medicare and medicaid. In addition to that, I want to compare the spendings between different states, to get some insights why some states have higher spending than the other and investigate if the differences are statistically significant. 



Data Sources:
I am using the datasets directly from https://www.data.gov/. 

```{r}
library(stringr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(jsonlite)
library(XML)
library(RCurl)
library(RMySQL)
library(ggmap)
library(gridExtra)
library(map)


setwd("C:/Users/blin261/Desktop/DATA607/DATA607Final")

raw_data <- read.table("Medicare_Hospital_Spending_by_Claim.csv", sep = ",", stringsAsFactors = FALSE, header = TRUE)
head(raw_data)
str(raw_data)
    
raw_complete <- subset(raw_data, raw_data$Period == "Complete Episode")

complete_episode <- raw_complete[, c("State", "Period", "Claim.Type", "Avg.Spending.Per.Episode..State.", "Avg.Spending.Per.Episode..Nation.")]

colnames(complete_episode) <- c("State", "Period", "Claim_Type", "Avg_Spending_Per_Episode_State", "Avg_Spending_Per_Episode_Nation")
head(complete_episode)

episode_cost <- complete_episode%>%
  group_by(State)%>%
  mutate(Percentage = as.numeric(sub("\\$", "", Avg_Spending_Per_Episode_State)) / as.numeric(sub("\\$", "", Avg_Spending_Per_Episode_Nation)), count = n())%>%
  unique()%>%
  arrange(desc(Percentage))
head(episode_cost)

ggplot(data = episode_cost, aes(x = reorder(episode_cost$State, -episode_cost$Percentage), y = episode_cost$Percentage, fill = State)) + geom_bar(stat = "identity") + coord_cartesian(ylim = c(0.9, 1.1))
```



```{r}
claim <- raw_data[, c("Hospital.Name", "State", "Period", "Claim.Type", "Avg.Spending.Per.Episode..State.", "Avg.Spending.Per.Episode..Nation.")]

colnames(claim) <- c("Hosital_Name", "State", "Period", "Claim_Type", "Avg_Spending_Per_Episode_State", "Avg_Spending_Per_Episode_Nation")   

head(claim)

claim_cost_NY <- claim%>%
  filter(State == "NY")%>%
  group_by(State, Claim_Type)%>%
  summarize(count = n(), ave_cost = sum(as.numeric(sub("\\$", "", Avg_Spending_Per_Episode_State))) / count, percentage = ave_cost / (sum(as.numeric(sub("\\$", "", Avg_Spending_Per_Episode_Nation)))/ count))
claim_cost_NY

claim_cost_CA <- claim%>%
  filter(State == "CA")%>%
  group_by(State, Claim_Type)%>%
  summarize(count = n(), ave_cost = sum(as.numeric(sub("\\$", "", Avg_Spending_Per_Episode_State))) / count, percentage = ave_cost / (sum(as.numeric(sub("\\$", "", Avg_Spending_Per_Episode_Nation)))/ count))
claim_cost_CA  


claim_cost <- rbind(claim_cost_NY, claim_cost_CA)
ggplot(data = claim_cost, aes(x = Claim_Type, y = percentage, fill = State)) + geom_bar(stat = "identity", position = "dodge") + ggtitle("NY and CA Claim Cost Comparison")+ xlab("Claim Type") + ylab("Percentage to the National Average")

```


Drug utilization data are reported by states for covered outpatient drugs that are paid for by state Medicaid agencies since the start of the Medicaid Drug Rebate Program. The data includes state, drug name, National Drug Code, number of prescriptions and dollars reimbursed.
```{r}
setwd("C:/Users/blin261/Desktop/DATA607/DATA607Final")
raw_data1 <- read.table("State_Drug_Utilization_Data_2016.csv", sep = ",", stringsAsFactors = FALSE, header = TRUE)

head(raw_data1)
str(raw_data1)

state_drug_cost <- raw_data1%>%
  group_by(State, X_latitude, X_longitude)%>%
  summarize(total_drug_cost = sum(Medicaid.Amount.Reimbursed, na.rm = TRUE))%>%
  filter(total_drug_cost != 0 & !is.na(X_latitude) & !is.na(X_longitude))
state_drug_cost


usa <- map_data("state")
ggplot() +
geom_path(data = usa, aes(x = long, y = lat, group = group)) +
geom_point(data = state_drug_cost, aes(x = X_longitude, y = X_latitude, size = total_drug_cost), color = "red")
```


```{r}
total_cost <- raw_data1%>%
  group_by(State, Product.Name)%>%
  summarize(product_cost = sum(Medicaid.Amount.Reimbursed, na.rm = TRUE), count = sum(Units.Reimbursed, na.rm = TRUE))%>%
  filter(product_cost != 0 & count != 0)%>% 
  arrange(desc(product_cost))

total_cost <- total_cost%>%
  mutate(ave_drug_cost = product_cost / count, average = mean(ave_drug_cost), sd = sd(ave_drug_cost))
head(total_cost, 10)
```



```{r}
NY_meds <- subset(total_cost, total_cost$State == "NY")
NY <- ggplot(head(NY_meds, 10), aes(x = reorder(Product.Name, -product_cost), y = product_cost)) + geom_bar(stat = "identity") + ggtitle("NY Highest Cost Medications")+ xlab("Product Name") + ylab("Product Total Cost")

CA_meds <- subset(total_cost, total_cost$State == "CA")
CA <- ggplot(head(CA_meds, 10), aes(x = reorder(Product.Name, -product_cost), y = product_cost)) + geom_bar(stat = "identity") + ggtitle("CA Highest Cost Medications")+ xlab("Product Name") + ylab("Product Total Cost")

FL_meds <- subset(total_cost, total_cost$State == "FL")
FL <- ggplot(head(FL_meds, 10), aes(x = reorder(Product.Name, -product_cost), y = product_cost)) + geom_bar(stat = "identity") + ggtitle("FL Highest Cost Medications")+ xlab("Product Name") + ylab("Product Total Cost")

grid.arrange(NY, CA, FL, nrow=3, ncol=1)

NY_meds <- NY_meds%>%
  mutate(ave_drug_cost = product_cost / count, mean = mean(ave_drug_cost), sd = sd(ave_drug_cost))
head(NY_meds)

CA_meds <- CA_meds%>%
  mutate(ave_drug_cost = product_cost / count, mean = mean(ave_drug_cost), sd = sd(ave_drug_cost))
head(CA_meds)

FL_meds <- FL_meds%>%
  mutate(ave_drug_cost = product_cost / count, mean = mean(ave_drug_cost), sd = sd(ave_drug_cost))
head(FL_meds)


anova_df <- rbind(NY_meds[,c(1, 5)], CA_meds[,c(1, 5)], FL_meds[,c(1, 5)])
head(anova_df)

drug_aov <- aov(anova_df$ave_drug_cost ~ anova_df$State)
summary(drug_aov)
TukeyHSD(drug_aov)
confint(drug_aov)
```
